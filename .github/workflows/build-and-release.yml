name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      create_release:
        description: 'Create GitHub Release'
        required: true
        default: 'true'
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore KickStatusChecker.Wpf/KickStatusChecker.Wpf.csproj
      
    - name: Build executable
      run: |
        dotnet publish KickStatusChecker.Wpf/KickStatusChecker.Wpf.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output ./publish `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:PublishTrimmed=false `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true
          
    - name: Create portable package
      run: |
        mkdir dist
        copy publish\KickStatusChecker.Wpf.exe dist\
        copy DISTRIBUTION_README.md dist\README.md
        
        # Create version info
        echo Kick Stream Monitor v${{ github.ref_name || inputs.version }} > dist\VERSION.txt
        echo Build Date: %date% %time% >> dist\VERSION.txt
        echo Platform: Windows x64 >> dist\VERSION.txt
        echo Type: Portable (No installation required) >> dist\VERSION.txt
        
    - name: Create portable zip
      run: |
        cd dist
        Compress-Archive -Path * -DestinationPath "../KickStreamMonitor-Portable-${{ github.ref_name || inputs.version }}.zip"
        cd ..
        
    - name: Generate checksums
      run: |
        cd dist
        Get-FileHash -Path *.exe -Algorithm SHA256 | ForEach-Object { "$($_.Hash.ToLower())  $($_.Name)" } > ../checksums.txt
        Get-FileHash -Path ..\*.zip -Algorithm SHA256 | ForEach-Object { "$($_.Hash.ToLower())  $($_.Name)" } >> ../checksums.txt
        cd ..
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: kick-stream-monitor-${{ github.ref_name || inputs.version }}
        path: |
          dist/
          *.zip
          checksums.txt
        retention-days: 30
        
    - name: Create Release
      if: (startsWith(github.ref, 'refs/tags/') || inputs.create_release == 'true')
      uses: softprops/action-gh-release@v1
      with:
        name: Kick Stream Monitor v${{ github.ref_name || inputs.version }}
        body: |
          ## Kick Stream Monitor v${{ github.ref_name || inputs.version }}
          
          ### ðŸ“¦ Downloads
          
          #### Portable Version (Recommended)
          - **KickStreamMonitor-Portable-${{ github.ref_name || inputs.version }}.zip** - Just extract and run, no installation required
          
          #### Files Included
          - `KickStatusChecker.Wpf.exe` - Main application
          - `README.md` - Installation and usage instructions
          - `VERSION.txt` - Build information
          
          ### ðŸš€ Quick Start
          1. Download the portable zip file
          2. Extract to any folder
          3. Run `KickStatusChecker.Wpf.exe`
          4. Enter a Kick username and start monitoring!
          
          ### âœ¨ Features
          - Real-time Kick stream status monitoring
          - System tray integration
          - Customizable update intervals
          - Multiple display modes
          - Persistent settings
          - Completely standalone (no .NET installation required)
          
          ### ðŸ”§ System Requirements
          - Windows 10 Version 1809+ or Windows 11
          - x64 (64-bit) architecture
          - 512MB RAM minimum
          
          ### ðŸ“‹ File Checksums
          ```
          ${{ steps.checksums.outputs.checksums }}
          ```
          
          For detailed instructions, see the README.md file included in the package.
        files: |
          KickStreamMonitor-Portable-${{ github.ref_name || inputs.version }}.zip
          checksums.txt
        draft: false
        prerelease: false
        generate_release_notes: true
